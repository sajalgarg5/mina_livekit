<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Audio Test</title>
    <style>
        body { background: #0c0cf8; color: white; font-family: sans-serif; text-align: center; padding-top: 50px; }
        #status { font-weight: bold; font-size: 24px; }
    </style>
</head>
<body>
    <div id="status">CLICK ANYWHERE TO START</div>
    <p>Listening to SSE audio stream...</p>

<script>
    const SSE_URL = "https://tel-retreat-pure-education.trycloudflare.com/listen_audio";
    const SAMPLE_RATE = 16000;
    
    let audioContext = null;

    // This matches the logic you provided
    function playAudio(base64Data) {
        if (!audioContext) return;

        try {
            // 1. Decode Base64 to binary
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // 2. Convert 16-bit PCM to Float32
            const int16Buffer = new Int16Array(bytes.buffer);
            const float32 = new Float32Array(int16Buffer.length);
            for (let i = 0; i < int16Buffer.length; i++) {
                float32[i] = int16Buffer[i] / 32768.0;
            }

            // 3. Play like your sample code
            const audioBuffer = audioContext.createBuffer(1, float32.length, SAMPLE_RATE);
            audioBuffer.copyToChannel(float32, 0);

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            
            // Start immediately as requested
            source.start();

        } catch (e) {
            console.error("Audio Playback Error:", e);
        }
    }

    function initSSE() {
        const ev = new EventSource(SSE_URL);
        
        ev.onopen = () => {
            document.getElementById("status").textContent = "CONNECTED - WAITING FOR AUDIO";
            console.log("SSE Connected");
        };

        ev.addEventListener("audio", (event) => {
            playAudio(event.data);
        });

        ev.onerror = (err) => {
            console.error("SSE Error:", err);
            document.getElementById("status").textContent = "CONNECTION ERROR";
        };
    }

    // Modern browsers require a click to allow audio
    window.onload = () => {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            document.getElementById("status").textContent = "AUDIO ENGINE READY";
            initSSE();
        }
    };
</script>
</body>
</html>